name: 'K8ssandra Verify Base Image Version'
description: 'Verifies the correct k8ssandra base image version was used during build'
inputs:
  cassandra_version:
    description: 'Expected Cassandra version (e.g., 5.0.6)'
    required: true
  base_version:
    description: 'Base version for directory path (e.g., 5.0)'
    required: true
  cqlai_version:
    description: 'cqlai version to install'
    required: true
  k8ssandra_digests_json:
    description: 'JSON mapping of Cassandra versions to k8ssandra base image digests'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Verify correct base image version in build
      shell: bash
      run: |
        echo "=== Verifying base image version in build ==="

        # Get the k8ssandra base image digest for this version
        DIGEST=$(echo '${{ inputs.k8ssandra_digests_json }}' | jq -r '.["${{ inputs.cassandra_version }}"]')
        if [ "$DIGEST" = "null" ] || [ -z "$DIGEST" ]; then
          echo "ERROR: No digest found for Cassandra version ${{ inputs.cassandra_version }}"
          exit 1
        fi
        echo "Using k8ssandra base digest: $DIGEST"

        # Rebuild with output to capture logs
        docker build \
          --build-arg CASSANDRA_VERSION=${{ inputs.cassandra_version }} \
          --build-arg MAJOR_VERSION=${{ inputs.base_version }} \
          --build-arg K8SSANDRA_BASE_DIGEST=$DIGEST \
          --build-arg CQLAI_VERSION=${{ inputs.cqlai_version }} \
          -t axonops-cassandra:verify \
          ./k8ssandra/${{ inputs.base_version }} 2>&1 | tee /tmp/build-output.log

        # Check for version echo in build output
        if ! grep -q "AXONOPS_BUILD: Inheriting from k8ssandra/cass-management-api:${{ inputs.cassandra_version }}-ubi" /tmp/build-output.log; then
          echo "ERROR: Build did not use correct base image!"
          echo "Expected: k8ssandra/cass-management-api:${{ inputs.cassandra_version }}-ubi"
          echo ""
          echo "AXONOPS_BUILD logs:"
          grep "AXONOPS_BUILD" /tmp/build-output.log || echo "(no AXONOPS_BUILD messages found)"
          exit 1
        fi

        echo "âœ“ Verified building from k8ssandra/cass-management-api:${{ inputs.cassandra_version }}-ubi"
